<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catálogo de Libros</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    label {
      display: inline-block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    input {
      margin-bottom: 20px;
      padding: 8px;
      width: 100%;
      max-width: 400px;
    }
    .pagination {
      margin-top: 10px;
    }
    .pagination button {
      padding: 8px 12px;
      margin-right: 5px;
    }
    .visually-hidden {
      position: absolute !important;
      height: 1px; 
      width: 1px; 
      overflow: hidden;
      clip: rect(1px,1px,1px,1px);
      white-space: nowrap;
      border: 0;
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>
  <h1>Catálogo de Libros</h1>

  <!-- Etiqueta asociada al campo de búsqueda para mejorar la accesibilidad -->
  <label for="buscador">Buscar en el catálogo:</label>
  <input 
    type="text" 
    id="buscador" 
    placeholder="Ej. El Quijote"
    aria-label="Campo de búsqueda para filtrar los libros por texto"
  >

  <div id="catalogo-libros">Cargando catálogo de libros...</div>
  <div class="pagination" id="pagination-controls"></div>

  <script>
    // Función de debounce: retrasa la ejecución de 'func' hasta que pasen 'delay' ms sin más invocaciones
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    document.addEventListener('DOMContentLoaded', function() {
      const catalogoDiv = document.getElementById('catalogo-libros');
      const buscador = document.getElementById('buscador');
      const paginationControls = document.getElementById('pagination-controls');

      // URL del CSV (puede ser el enlace de Google Sheets o un CSV alojado en tu hosting)
      const urlCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlqKvq21xTVerkiDU_ZKitDj5C7go3VFfk3n046kNm9ev_tc3fV4z_fq8GVA3J8LqWfcsYPOlBt3OM/pub?output=csv';

      let globalData = [];   // Todas las filas (sin encabezados)
      let headers = [];      // Encabezados de la tabla
      let currentPage = 1;
      const rowsPerPage = 50;
      let filteredData = []; // Datos filtrados según la búsqueda

      // Función para renderizar la tabla con los datos
      function renderTable(data) {
        // Creamos la tabla y sus secciones
        const table = document.createElement('table');
        table.setAttribute('aria-label', 'Tabla con el listado de libros disponibles');

        // Opcionalmente, podemos añadir un caption para describir la tabla
        // const caption = document.createElement('caption');
        // caption.textContent = 'Listado completo de libros con opción de búsqueda y paginación';
        // table.appendChild(caption);

        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');

        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        // Calculamos el rango de filas según la página actual
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);

        // Creamos las filas usando createElement para mayor eficiencia
        pageData.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell.trim(); // Eliminamos espacios sobrantes
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // Reemplazamos el contenido anterior por la nueva tabla
        catalogoDiv.innerHTML = '';
        catalogoDiv.appendChild(table);

        // Renderizamos los controles de paginación
        renderPagination(data);
      }

      // Función para renderizar los controles de paginación
      function renderPagination(data) {
        paginationControls.innerHTML = ''; // Limpiamos controles anteriores

        const totalRows = data.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (totalPages <= 1) return; // No mostrar paginación si solo hay una página

        // Botón "Anterior"
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Anterior';
        prevButton.disabled = (currentPage === 1);
        prevButton.setAttribute('aria-label', 'Ir a la página anterior');
        prevButton.addEventListener('click', function() {
          if (currentPage > 1) {
            currentPage--;
            renderTable(data);
          }
        });
        paginationControls.appendChild(prevButton);

        // Botón "Siguiente"
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Siguiente';
        nextButton.disabled = (currentPage === totalPages);
        nextButton.setAttribute('aria-label', 'Ir a la página siguiente');
        nextButton.addEventListener('click', function() {
          if (currentPage < totalPages) {
            currentPage++;
            renderTable(data);
          }
        });
        paginationControls.appendChild(nextButton);

        // Información de la página actual (con aria-live para lectores de pantalla)
        const info = document.createElement('span');
        info.setAttribute('aria-live', 'polite');
        info.style.marginLeft = '10px';
        info.textContent = `Página ${currentPage} de ${totalPages}`;
        paginationControls.appendChild(info);
      }

      // Función para filtrar los datos según la búsqueda
      function filterData(query) {
        if (query.trim() === '') {
          return globalData;
        }
        query = query.toLowerCase();
        return globalData.filter(row =>
          row.some(cell => cell.toLowerCase().includes(query))
        );
      }

      // Cargamos el CSV
      fetch(urlCSV)
        .then(response => response.text())
        .then(data => {
          const lines = data.split('\n').filter(line => line.trim() !== '');
          // Separamos encabezados y datos
          headers = lines[0].split(',');
          globalData = lines.slice(1).map(line => line.split(','));
          filteredData = globalData;

          // Renderizamos la tabla inicial
          renderTable(filteredData);
        })
        .catch(error => {
          catalogoDiv.textContent = 'Error al cargar el catálogo';
          console.error(error);
        });

      // Evento de búsqueda con debounce (300ms)
      buscador.addEventListener('input', debounce(function() {
        const query = buscador.value;
        filteredData = filterData(query);
        currentPage = 1; // Reiniciamos a la primera página tras la búsqueda
        renderTable(filteredData);
      }, 300));
    });
  </script>
</body>
</html>
